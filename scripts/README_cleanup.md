# 向量数据库清理工具

这个工具用于清理向量数据库中的孤立数据，确保向量数据库与MySQL数据库保持同步。

## 功能说明

- 从MySQL数据库的`documents`表中获取所有文档ID
- 扫描向量数据库中的所有chunks，找出属于已删除文档的孤立chunks
- 删除这些孤立的chunks，防止数据干扰

## 使用方法

### 1. 试运行模式（推荐）

```bash
# 默认为试运行模式，只检查不删除
python cleanup_vector_db.py

# 或者明确指定试运行
python cleanup_vector_db.py --dry-run
```

### 2. 强制执行模式

```bash
# 实际执行删除操作
python cleanup_vector_db.py --force
```

### 3. 调整日志级别

```bash
# 详细调试信息
python cleanup_vector_db.py --log-level DEBUG

# 只显示警告和错误
python cleanup_vector_db.py --log-level WARNING
```

## 安全特性

1. **默认试运行**: 默认情况下只检查不删除，需要明确使用`--force`参数才会实际删除数据
2. **二次确认**: 在强制执行模式下，会要求用户输入'YES'进行确认
3. **分批删除**: 大量数据会分批删除，避免系统负载过高
4. **详细日志**: 提供详细的操作日志，便于追踪和调试

## 输出示例

```
=== 试运行模式 ===
使用 --force 参数来实际执行删除操作
2024-01-20 10:30:00 - INFO - 数据库连接初始化完成
2024-01-20 10:30:01 - INFO - 从MySQL获取到 150 个文档ID
2024-01-20 10:30:02 - INFO - 从向量数据库获取到 180 个文档ID
2024-01-20 10:30:03 - INFO - 发现 30 个孤立的文档ID
2024-01-20 10:30:04 - INFO - 发现 120 个孤立的chunks
2024-01-20 10:30:05 - INFO - 试运行模式：发现 120 个孤立chunks，但不会实际删除

=== 清理结果 ===
状态: dry_run
MySQL文档数: 150
向量数据库文档数: 180
孤立文档数: 30
孤立chunks数: 120
已删除chunks数: 0

使用 --force 参数来实际执行删除操作
```

## 注意事项

1. **备份数据**: 在执行实际删除操作前，建议备份向量数据库
2. **停止服务**: 建议在清理期间停止相关服务，避免数据冲突
3. **定期清理**: 建议定期运行此工具，保持数据库整洁
4. **监控日志**: 注意观察清理过程中的日志，及时发现异常

## 故障排除

### 连接失败
- 检查数据库配置文件
- 确认MySQL和ChromaDB服务正常运行
- 检查网络连接

### 权限错误
- 确认数据库用户有足够的权限
- 检查文件系统权限

### 内存不足
- 对于大型数据库，可能需要调整批处理大小
- 考虑在低峰时段运行